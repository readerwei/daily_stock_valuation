# Project Zipline: Financial Data Analysis and Automated Trading

This project is a comprehensive system for fetching, analyzing, and reporting on financial data for a list of stock tickers, with capabilities for automated trade execution. It leverages various data sources, stores information in a ClickHouse database, and generates daily reports and trading signals.

## Project Structure and Key Scripts

The project is organized around several Python scripts, each serving a distinct purpose in the financial data pipeline:

### `get_eps.py` Script

*   **Purpose:** Fetches comprehensive financial data (Earnings Per Share, Price-to-Earnings ratios, analyst estimates including low, high, and average, historical P/E ranges) for a list of stock tickers.
*   **Data Sources:** Utilizes `yfinance` to retrieve current stock information and historical financial statements from Yahoo Finance. It also queries the ClickHouse database for historical forward P/E percentiles (from `stock_forward_pe_history` table).
*   **Calculations:** Calculates Trailing Twelve Months (TTM) EPS and determines historical P/E ranges (minimum and maximum over a 5-year period). It also estimates forward prices based on forward EPS and historical forward P/E percentiles.
*   **Database Interaction:** Connects to a ClickHouse database, automatically creates the `stock_financial_data` table if it doesn't exist, deletes existing data for the current date to prevent duplicates, and inserts the newly fetched and calculated data.
*   **Configurable Ticker List:** The list of stock tickers to process is dynamically loaded from the `zipline.yaml` configuration file, specifically from the `alpaca.custom_asset_list` key.

### `get_forward_pe_playwright.py` Script

*   **Purpose:** Scrapes historical quarterly forward P/E ratios for a list of stock tickers from gurufocus.com.
*   **Web Scraping:** Employs `playwright` for browser automation to navigate gurufocus.com and `beautifulsoup4` for parsing the HTML content. It incorporates random delays to simulate human browsing behavior and includes basic detection for Cloudflare blocking.
*   **Database Interaction:** Connects to the ClickHouse database, creates the `stock_forward_pe_history` table (using a `ReplacingMergeTree` engine for efficient deduplication) if it doesn't exist, inserts the scraped historical P/E data, and optimizes the table to enforce deduplication.
*   **Flexible Ticker Input:** The script can be executed for a single ticker provided as a command-line argument, or it can process all tickers listed in the `zipline.yaml` file under the `alpaca.custom_asset_list` key.
*   **Manual Table Creation:** Supports a `--create-table` command-line flag for one-time table creation, preventing recreation on every run.

### `dailyExecute.py` Script

*   **Purpose:** Executes daily buy and sell orders on the Alpaca trading platform based on trading signals generated by the `dailyReport.py` script.
*   **Trading Platform Integration:** Interacts directly with the Alpaca trading API (`alpaca_trade_api`) to manage trading activities.
*   **Workflow:**
    *   Loads Alpaca API credentials (key ID, secret key, base URL) from a `zipline-trader.yaml` file (expected at `/home/wei/Documents/zipline-yaml/zipline-trader.yaml`).
    *   Fetches the current account status, including available cash and existing positions.
    *   Cancels all previously open orders to ensure a clean slate for new trades.
    *   Loads daily trading signals (buy/sell recommendations) from a `daily.pkl` file.
    *   **Sell Logic:** Identifies equities with an RSI above 80 (indicating overbought conditions) and an unrealized profit of at least 5%. For such equities, it places a limit sell order at the upper Bollinger Band price.
    *   **Buy Logic:** Identifies equities with an RSI below 20 (indicating oversold conditions). For these, it calculates a quantity to buy (allocating 1/10th of available cash per trade) and places a limit buy order at the lower Bollinger Band price.

### `dailyReport.py` Script

*   **Purpose:** Generates a daily financial report using Zipline's pipeline API, calculating various technical indicators and custom factors, and then sends this report via email.
*   **Zipline Integration:**
    *   Loads the `alpaca_api` Zipline bundle for historical data.
    *   Configures a `USEquityPricingLoader` and `SimplePipelineEngine` for data processing.
    *   Defines a universe of assets, typically the top 10 by average dollar volume.
    *   Incorporates a range of built-in Zipline factors (e.g., `AverageDollarVolume`, `Returns`, `RSI`, `MACDSignal`, `BollingerBands`, `EquityPricing.close`).
    *   Includes custom Zipline factors like `MeanReversion` and `MACDHist` for specialized analysis.
*   **Workflow:**
    *   Determines the start and end dates for the pipeline run, with the end date provided as a command-line argument.
    *   Executes the Zipline pipeline to generate financial data and signals.
    *   Post-processes the pipeline output, including scaling dollar volume and converting returns to percentages.
    *   Saves the processed results to a `daily.pkl` file, which serves as input for `dailyExecute.py`.
*   **Reporting & Emailing:** Formats the processed data into an HTML report and sends it to a predefined recipient via SSL SMTP. Email credentials (`EMAIL_PASS`) are loaded from environment variables.

### `forward_price_report.py` Script

*   **Purpose:** Generates a report comparing estimated forward prices (including 1yr low and high) with current market prices for stocks, and then emails this report.
*   **Data Retrieval:** Fetches estimated forward price ranges from the `stock_financial_data` table in the ClickHouse database. Current stock prices are obtained from Yahoo Finance using `yfinance`.
*   **Analysis:** For each stock, it determines whether its current market price is "Below," "Above," or "Within" its estimated forward price range.
*   **Reporting & Emailing:** Compiles the analysis into an HTML table and sends it as an email report via SSL SMTP. Email credentials (`EMAIL_PASS`) are loaded from environment variables.

## Configuration (`zipline.yaml`)

...
