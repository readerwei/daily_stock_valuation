# Project Zipline: Financial Data Analysis and Automated Trading

This project is a comprehensive system for fetching, analyzing, and reporting on financial data for a list of stock tickers, with capabilities for automated trade execution. It leverages various data sources, stores information in a ClickHouse database, and generates daily reports and trading signals.

## Project Structure and Key Scripts

The project is organized around several Python scripts, each serving a distinct purpose in the financial data pipeline:

### `get_eps.py` Script

*   **Purpose:** Fetches comprehensive financial data (Earnings Per Share, Price-to-Earnings ratios, analyst estimates including low, high, and average, historical P/E ranges) for a list of stock tickers.
*   **Data Sources:** Utilizes `yfinance` to retrieve current stock information and historical financial statements from Yahoo Finance. It also queries the ClickHouse database for historical forward P/E percentiles (from `stock_forward_pe_history` table).
*   **Calculations:** Calculates Trailing Twelve Months (TTM) EPS and determines historical P/E ranges (minimum and maximum over a 5-year period). It also estimates forward prices based on forward EPS and historical forward P/E percentiles.
*   **Database Interaction:** Connects to a ClickHouse database, automatically creates the `stock_financial_data` table if it doesn't exist, deletes existing data for the current date to prevent duplicates, and inserts the newly fetched and calculated data.
*   **Configurable Ticker List:** The list of stock tickers to process is dynamically loaded from the `zipline.yaml` configuration file, specifically from the `alpaca.custom_asset_list` key.

### `get_forward_pe_playwright.py` Script

*   **Purpose:** Scrapes historical quarterly forward P/E ratios for a list of stock tickers from gurufocus.com.
*   **Web Scraping:** Employs `playwright` for browser automation to navigate gurufocus.com and `beautifulsoup4` for parsing the HTML content. It incorporates random delays to simulate human browsing behavior and includes basic detection for Cloudflare blocking.
*   **Database Interaction:** Connects to the ClickHouse database, creates the `stock_forward_pe_history` table (using a `ReplacingMergeTree` engine for efficient deduplication) if it doesn't exist, inserts the scraped historical P/E data, and optimizes the table to enforce deduplication.
*   **Flexible Ticker Input:** The script can be executed for a single ticker provided as a command-line argument, or it can process all tickers listed in the `zipline.yaml` file under the `alpaca.custom_asset_list` key.
*   **Manual Table Creation:** Supports a `--create-table` command-line flag for one-time table creation, preventing recreation on every run.

### `dailyExecute.py` Script

*   **Purpose:** Executes daily buy and sell orders on the Alpaca trading platform based on trading signals generated by the `dailyReport.py` script.
*   **Trading Platform Integration:** Interacts directly with the Alpaca trading API (`alpaca_trade_api`) to manage trading activities.
*   **Workflow:**
    *   Loads Alpaca API credentials (key ID, secret key, base URL) from a `zipline-trader.yaml` file (expected at `/home/wei/Documents/zipline-yaml/zipline-trader.yaml`).
    *   Fetches the current account status, including available cash and existing positions.
    *   Cancels all previously open orders to ensure a clean slate for new trades.
    *   Loads daily trading signals (buy/sell recommendations) from a `daily.pkl` file.
    *   **Sell Logic:** Identifies equities with an RSI above 80 (indicating overbought conditions) and an unrealized profit of at least 5%. For such equities, it places a limit sell order at the upper Bollinger Band price.
    *   **Buy Logic:** Identifies equities with an RSI below 20 (indicating oversold conditions). For these, it calculates a quantity to buy (allocating 1/10th of available cash per trade) and places a limit buy order at the lower Bollinger Band price.

### `dailyReport.py` Script

*   **Purpose:** Generates a daily financial report using Zipline's pipeline API, calculating various technical indicators and custom factors, and then sends this report via email.
*   **Zipline Integration:**
    *   Loads the `alpaca_api` Zipline bundle for historical data.
    *   Configures a `USEquityPricingLoader` and `SimplePipelineEngine` for data processing.
    *   Defines a universe of assets, typically the top 10 by average dollar volume.
    *   Incorporates a range of built-in Zipline factors (e.g., `AverageDollarVolume`, `Returns`, `RSI`, `MACDSignal`, `BollingerBands`, `EquityPricing.close`).
    *   Includes custom Zipline factors like `MeanReversion` and `MACDHist` for specialized analysis.
*   **Workflow:**
    *   Determines the start and end dates for the pipeline run, with the end date provided as a command-line argument.
    *   Executes the Zipline pipeline to generate financial data and signals.
    *   Post-processes the pipeline output, including scaling dollar volume and converting returns to percentages.
    *   Saves the processed results to a `daily.pkl` file, which serves as input for `dailyExecute.py`.
*   **Reporting & Emailing:** Formats the processed data into an HTML report and sends it to a predefined recipient via SSL SMTP. Email credentials (`EMAIL_PASS`) are loaded from environment variables.

### `forward_price_report.py` Script

*   **Purpose:** Generates a report comparing estimated forward prices with current market prices for stocks, and then emails this report.
*   **Data Retrieval:** Fetches estimated forward price ranges from the `stock_financial_data` table in the ClickHouse database. Current stock prices are obtained from Yahoo Finance using `yfinance`.
*   **Analysis:** For each stock, it determines whether its current market price is "Below," "Above," or "Within" its estimated forward price range.
*   **Reporting & Emailing:** Compiles the analysis into an HTML table and sends it as an email report via SSL SMTP. Email credentials (`EMAIL_PASS`) are loaded from environment variables.

## Configuration (`zipline.yaml`)

The `zipline.yaml` file serves as a central configuration point for the project. Its structure is as follows:

```yaml
alpaca:
  custom_asset_list: SPY, AAPL, MSFT, GOOG, AMZN, TSLA, AMD, NVDA, TSM, F, BRK.B, BABA, TCEHY, AAL, ABNB, PLTR, HOOD, COUR
```

*   **`alpaca.custom_asset_list`**: A comma-separated string of stock tickers that the scripts will process. This allows for easy modification of the target asset universe without altering code.

## Dependencies (`requirements.txt`)

All necessary Python libraries for this project are listed in `requirements.txt`. To install them, run:

```bash
pip install -r requirements.txt
```

The key dependencies include:
*   `yfinance`: For fetching financial data from Yahoo Finance.
*   `PyYAML`: For reading YAML configuration files.
*   `pandas`: For data manipulation and analysis.
*   `clickhouse-driver`: For connecting to and interacting with the ClickHouse database.
*   `playwright`: For web scraping (browser automation).
*   `beautifulsoup4`: For parsing HTML content from web pages.
*   `alpaca_trade_api`: For interacting with the Alpaca trading platform.
*   `zipline`: The algorithmic trading library used for backtesting and live trading.
*   `trading_calendars`: Provides trading calendars for Zipline.
*   `python-dotenv`: For loading environment variables from `.env` files.
*   `talib`: Technical Analysis Library for various indicators.

## ClickHouse Setup

The project is configured to connect to a ClickHouse database with the following default settings:

*   **Host:** `192.168.1.36`
*   **Port:** `9000`
*   **Username:** `default`
*   **Password:** (none)
*   **Database:** `default`

The scripts will automatically create the necessary tables (`stock_financial_data` and `stock_forward_pe_history`) if they do not exist.

### `stock_financial_data` Table Schema

```sql
CREATE TABLE default.stock_financial_data
(
    `ticker` String,
    `date` Date,
    `trailing_eps` Nullable(Float64),
    `forward_eps` Nullable(Float64),
    `trailing_pe` Nullable(Float64),
    `forward_pe` Nullable(Float64),
    `pe_range_low_5y` Nullable(Float64),
    `pe_range_high_5y` Nullable(Float64),
    `analyst_eps_range_low_0q` Nullable(Float64),
    `analyst_eps_range_high_0q` Nullable(Float64),
    `analyst_eps_range_avg_0q` Nullable(Float64),
    `analyst_eps_range_low_p1q` Nullable(Float64),
    `analyst_eps_range_high_p1q` Nullable(Float64),
    `analyst_eps_range_avg_p1q` Nullable(Float64),
    `analyst_eps_range_low_0y` Nullable(Float64),
    `analyst_eps_range_high_0y` Nullable(Float64),
    `analyst_eps_range_avg_0y` Nullable(Float64),
    `analyst_eps_range_low_p1y` Nullable(Float64),
    `analyst_eps_range_high_p1y` Nullable(Float64),
    `analyst_eps_range_avg_p1y` Nullable(Float64),
    `forward_pe_perc_25` Nullable(Float64),
    `forward_pe_perc_50` Nullable(Float64),
    `forward_pe_perc_75` Nullable(Float64),
    `estimated_forward_price_low` Nullable(Float64),
    `estimated_forward_price_high` Nullable(Float64)
)
ENGINE = MergeTree()
PARTITION BY toYYYYMM(date)
ORDER BY (ticker, date);
```

### `stock_forward_pe_history` Table Schema

```sql
CREATE TABLE IF NOT EXISTS default.stock_forward_pe_history
(
    `ticker` String,
    `date` Date,
    `forward_pe` Float64
)
ENGINE = ReplacingMergeTree()
PARTITION BY toYYYYMM(date)
ORDER BY (ticker, date);
```

## How to Use

1.  **Install Dependencies:**
    ```bash
    pip install -r requirements.txt
    ```
2.  **Configure Tickers:** Edit `zipline.yaml` to specify your desired stock tickers under `alpaca.custom_asset_list`.
3.  **ClickHouse Setup:** Ensure your ClickHouse database is running and accessible at the configured host and port.
    *   For `stock_forward_pe_history` table, run:
        ```bash
        python get_forward_pe_playwright.py --create-table
        ```
4.  **Run Data Fetching Scripts:**
    *   To fetch EPS and related data:
        ```bash
        python get_eps.py
        ```
    *   To fetch historical forward P/E data (for all tickers in `zipline.yaml`):
        ```bash
        python get_forward_pe_playwright.py
        ```
        Or for a single ticker:
        ```bash
        python get_forward_pe_playwright.py AAPL
        ```
5.  **Generate Daily Report:**
    ```bash
    python dailyReport.py YYYY-MM-DD # Replace YYYY-MM-DD with the desired end date
    ```
6.  **Execute Daily Trades (Paper Trading Recommended):**
    ```bash
    python dailyExecute.py
    ```
7.  **Generate Forward Price Report:**
    ```bash
    python forward_price_report.py
    ```

**Note on Credentials:** API keys and email passwords should be managed securely, preferably via environment variables (e.g., in a `.env` file) and never committed directly to version control. The `zipline.yaml` file, if it contains sensitive information, should also be handled with care or ignored by Git.